<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Nifty Mapworks</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: relative;
        top: 0;
        bottom: 0;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <style>
      #map {
        position: absolute;
        left: 25%;
        top: 0;
        bottom: 0;
        width: 75%;
      }
      .map-overlay {
        position: absolute;
        width: 25%;
        top: 0;
        bottom: 0;
        left: 0;
        font: 12px/20px "Helvetica Neue", Arial, Helvetica, sans-serif;
        background-color: #efefef;
        max-height: 100%;
        overflow: hidden;
      }

      .map-overlay fieldset {
        display: none;
        background: #ddd;
        border: none;
        padding: 10px;
        margin: 0;
      }

      .map-overlay input {
        display: block;
        border: none;
        width: 100%;
        border-radius: 3px;
        padding: 10px;
        margin: 0;
        box-sizing: border-box;
      }

      .map-overlay .listing {
        overflow: auto;
        max-height: 100%;
      }

      .map-overlay .listing > * {
        display: block;
        padding: 5px 10px;
        margin: 0;
      }

      .map-overlay .listing a {
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        color: #404;
        text-decoration: none;
      }

      .map-overlay .listing a:last-child {
        border: none;
      }

      .map-overlay .listing a:hover {
        background: #f0f0f0;
      }
    </style>

    <div id="map"></div>

    <div class="map-overlay">
      <div id="feature-listing" class="listing"></div>
    </div>

    <script>
      // Data
      mapboxgl.accessToken =
        "pk.eyJ1IjoiYmlrZXJpZGEiLCJhIjoiY2l5bDJxcG83MDAyNDJxbnJmcWk0NzFxMSJ9.EWdwgIGRuN4ALQPvICFCog";
      let geoJSONFeatures = null;

      function uuid() {
        function s4() {
          return Math.floor((1 + Math.random()) * 0x10000)
            .toString(16)
            .substring(1);
        }
        return `${s4()}${s4()}-${s4()}-${s4()}-${s4()}-${s4()}-${s4()}-${s4()}`;
      }

      async function streamToString(stream) {
        const reader = stream.getReader();
        const textDecoder = new TextDecoder();
        let result = "";
        async function read() {
          const { done, value } = await reader.read();
          if (done) return result;
          result += textDecoder.decode(value, { stream: true });
          return read();
        }
        return read();
      }

      async function startApp() {
        await fetch(
          "https://zanemeroff.github.io/geojson_test_file/area_loacations.json"
        ).then((data) => {
          streamToString(data.body).then((stringData) => {
            geoJSONFeatures = JSON.parse(stringData).map((item) => {
              return {
                type: "Feature",
                properties: {
                  id: item.id,
                  locationName: item.locationName,
                  link: item.link
                },
                geometry: {
                  type: "Polygon",
                  coordinates: [item.coordinates]
                },
              };
            });

            const map = new mapboxgl.Map({
              container: "map",
              // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
              style: "mapbox://styles/mapbox/streets-v12",
              center: [-105.5, 39],
              maxZoom: 20,
              minZoom: 1,
              zoom: 6,
            });

            function panToMapLocation(coord) {
              map.flyTo({
                center: coord,
                zoom: 8, // You can adjust the zoom level as needed
                speed: 1.5, // Speed of the animation
                curve: 1, // Curvature of the flight path
                essential: true // Indicates that this animation is essential for the user experience
              });
            }
            // Used to store the selected area's id
            let selectedAreaFeature = null;

            // Set the selected area's id
            function setSelectedAreaFeature(feature) {
              // @ZACK - do we need to save the entire feature here?
              selectedAreaFeature = feature;
              console.log('selectedAreaFeature: ', selectedAreaFeature)
            }

            // Holds visible airport features for filtering
            let airports = [];

            // Create a popup instance, but don't add it to the map yet
            const popup = new mapboxgl.Popup({
              closeButton: false,
              closeOnClick: false
            });

            const filterEl = document.getElementById("feature-filter");
            const listingEl = document.getElementById("feature-listing");

            map.on("load", () => {
              console.log("geoJSONFeatures: ", geoJSONFeatures);

              for (const feature of geoJSONFeatures) {
                // Add a data source containing the GeoJSON data
                map.addSource(feature.properties.id, {
                  type: "geojson",
                  data: feature,
                });

                const fillLayerId = uuid();

                // Add map layer - filled area polygon
                map.addLayer({
                  id: fillLayerId,
                  type: "fill",
                  source: feature.properties.id, // reference the data source
                  layout: {},
                  properties: {
                    locationName: feature.properties.locationName
                  },
                  paint: {
                    "fill-color": "#0080ff", // blue color fill
                    "fill-opacity": 0.5,
                  },
                });

                // Add map layer - area polygon border
                map.addLayer({
                  id: uuid(),
                  type: "line",
                  source: feature.properties.id,
                  layout: {},
                  paint: {
                    "line-color": "#000",
                    "line-width": 3,
                  },
                });

                const popUpHTML = `
                  <div>
                    <p>${feature.properties.locationName}</p>
                    <a href="${feature.properties.link}" target="_blank">VIEW PRODUCT</a>
                  </div>
                `

                map.on("mousemove", fillLayerId, (e) => {
                  // Change the cursor to a pointer when hovering the feature
                  map.getCanvas().style.cursor = "pointer";

                  // Target the feature being hovered
                  const mouseEventFeature = e.features[0]; // This isn't really needed?

                  // Create a popup for the feature and add it to the map
                  popup
                    .setLngLat(mouseEventFeature.geometry.coordinates[0][0]) // BONUS: get this to find the center of the top line
                    .setHTML(popUpHTML)  
                    .addTo(map);
                });

                map.on("mouseleave", fillLayerId, () => {
                  // Reset the cursor back to a grab hand when the mouse leaves the feature
                  map.getCanvas().style.cursor = "";
                });

                map.on("mousedown", fillLayerId, (e) => {
                  console.log('CLICK!')
                  setSelectedAreaFeature(feature)
                  // Do we need to do anything with this? If not this selectedAreaFeature stuff can be removed.
                });

                const element = document.createElement("div");
                element.innerHTML = feature.properties.locationName;
                element.style = `
                  border-bottom: 1px solid black; 
                  cursor: pointer;
                  width: 100%;
                `
                element.onclick = () => panToMapLocation(feature.geometry.coordinates[0][0]) 
                element.addEventListener("mouseover", () => {
                  // Highlight corresponding feature on the map
                  popup
                    .setLngLat(feature.geometry.coordinates[0][0])
                    .setHTML(popUpHTML)  
                    .addTo(map);
                });

                listingEl.appendChild(element);
              }
            }); 
          });
        });
      }

      startApp();
    </script>
  </body>
</html>
